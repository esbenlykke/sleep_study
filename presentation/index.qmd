---
title: "Sleep Quality Estimation using Accelerometer Data from Thigh-Mounted Devices During in Free Living Conditions"
subtitle: "(working title)"
author: "Esben Lykke, PhD student"
date: "`r format(Sys.Date(), '%d %B, %Y')`"
format:
  revealjs:
    smaller: false
    theme: moon
    slide-number: true
    preview-links: auto
    logo: visuals/SDU_WHITE_RGB-png.png
    footer: https://github.com/esbenlykke/sleep_study
    css: my_styles.css
    scrollable: true
embed-resources: true
editor_options: 
  chunk_output_type: console
smooth-scroll: true
bibliography: references.bib
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE)

library(visNetwork)
library(tidymodels)
library(tidyverse)
```

# Background {transition="fade"}

## Background {transition="convex" .smaller}

- Sleep plays a vital role in health, thus, improving the assessment of sleepâ€“wake outside of a laboratory environment is critical
- The gold standard (PSG) is costly and inconvenient.
- Methods for estimating sleep/wake based on accelerometry exist, primarily from wrist-worn devices
- Cole-Kripke and Sadeh algorithms are commonly used
- determine in-bed time is difficult, usually set by sleep log and/or human scorers
- detect wakefulness is difficult, worse performance in populations with sleep disorders
- typically a two level analysis: epoch based and summarized across night(s)
- Zmachine-derived sleep stats
- Purpose... 

## But Esben, what about them sleep stages!? {transition="convex" .smaller}

* I did free-living PSG recordings of sleep but...
  - Super fragile -> shitty data
  - Combersome and time consuming
  - free-living when wired up like a robot?
  - would surface skin temperature + acc be enough? Most likely needs HR
  
It was likely a dead end from the get-go :(

# Methods {transition="fade"}

## Methods {transition="convex" .smaller}

- data preparation, big time-consumer is handling raw acc data
- only thigh data used. HSBC and other is only thigh data...
- all zm recording is considered as in-bed (sensor problem?)
- no sleep stages, only sleep/awake
- sensor problems during sleep, up to 20 consecutive epochs (200 sec) are treated as sleep
- Combine binary classifiers to produce multilabel outcomes (i.e., binary Relevance)
- Evaluated combined classifiers using weighted micro-averaging.
- adjust threshold for in bed awake or give edge in tie breakers??
- zm sleep stats inclusion criteria
- three approaches: tw- binary (risk of ghost classes), binary relevance (choosing the right tie breaker), and multiclass

## Exclusion Criteria {transition="convex" .H2}

```{r}
#| fig-align: center
source(here::here("presentation/code/flowchart_eligible_nights.R"))

flow
```

::: aside
1. @hirshkowitz_national_2015
:::


## Features {transition="convex" .H2 .smaller}

:::: {.columns}

::: {.fragment .column width="30%"}

**Basic Features**

- Weekday 
- Time of Day
- Placement
- Temperature

:::

::: {.fragment .column width="30%"}

**ACC derived features**^[@skotte_detection_2014]

- Mean ACC X 
- Mean ACC Y
- Mean ACC Z
- Standard Deviation X
- Standard Deviation Y
- Standard Deviation Z
- Max Standard Deviation
- Inclination

:::

::: {.fragment .column width="40%"}

**Sensor-Independent Features**^[@walch_sleep_2019, @forger_simpler_1999]

- Clock Proxy Linear
- Clock Proxy Cosinus

:::

::::

---

## Human Circadian Clock {transition="convex" .smaller}

@forger_simpler_1999: a so-called cubic van der Pol equation

::: {.fragment}
$$\frac{dx_c}{dt}=\frac{\pi}{12}\begin{cases}\mu(x_c-\frac{4x^3}{3})-x\begin{bmatrix}(\frac{24}{0.99669\tau_x})^2+kB\end{bmatrix}\end{cases}$$
:::

::: {.fragment .fade-in-then-semi-out}
This thing is dependent on ambient light and body temperature!
:::

::: {.fragment .fade-in-then-semi-out}
@walch_sleep_2019 incorporated this feature using step counts from the Apple Watch
:::

::: {.fragment}
But as demonstrated by @walch_sleep_2019, a simple cosine function does the trick just as well :)
:::

## Circadian Proxy Features {transition="fade"}

```{r}
source(here::here("presentation/code/plot_sensor-independent.R"))

plot_proxy_cos
```

## Circadian Proxy Features {transition="fade"}

```{r}
source(here::here("presentation/code/plot_sensor-independent.R"))

plot_proxy_lin
```

## Present three modeling approaches  {.smaller}

::: {.fragment}
- Multiclass classifier with three labels: in-bed-asleep, in-bed-awake, and out-bed-awake
  - pros: simplicity, speed, joint modeling, consistency across classes
  - cons: struggle with class imbalance, performance
:::

::: {.fragment}
- Two binary classifiers: in-bed/out-bed and asleep/awake
  - pros: 
  - cons: ghost classes
:::

::: {.fragment}
- Three binary classifiers: in-bed-asleep 1/0, in-bed-awake 1/0, and out-bed-awake 1/0
  - pros: more flexible, can better handle class imbalance
  - cons: complex training, low speed, feature redundancy
:::

## Estimate Sleep Quality Metrics {transition="fade"}

```{r}
#| fig-asp: .4
source(here::here("presentation/code/plot_pred_example.R"))

multiclass_ex
```

## Estimate Sleep Quality Metrics {transition="fade"}

```{r}
#| fig-asp: .4

multiclass_lps
```

## Estimate Sleep Quality Metrics {transition="fade"}

```{r}
#| fig-asp: .4

multiclass_tst
```
## Estimate Sleep Quality Metrics {transition="fade"}

```{r}
#| fig-asp: .4

br_ex
```

## Estimate Sleep Quality Metrics {transition="fade"}

```{r}
#| fig-asp: .4
br_lps
```

## Estimate Sleep Quality Metrics {transition="fade"}

```{r}
#| fig-asp: .4
br_tst
```

## Estimate Sleep Quality Metrics {transition="fade"}

```{r}
#| fig-asp: .4
plot_ex
```

## Estimate Sleep Quality Metrics {transition="fade"}

```{r}
#| fig-asp: .4
plot_lps
```

## Estimate Sleep Quality Metrics {transition="fade"}

```{r}
#| fig-asp: .4
plot_tst
```

## Sequential Classifiers

![](visuals/chained_models_data_flow.png)

# Results {transition="fade"}

## {.H2 transition="convex" .smaller}

:::: {.columns}
::: {.column width="50%"}

### Epoch-Based {.smaller}

* Performance Metrics
  - F1 Score
  - Accuracy
  - Sensitivity
  - Specificity
  - ROC curves
  
:::

::: {.column width="50%"}

### Summarized across nights {.H3 .smaller}

* Agreement With Zmachine Sleep Stats 
  - Sleep Period Time
  - Total Sleep Time
  - Sleep Efficiency
  - Latency Until Persistent Sleep
  - Wake After Sleep Onset
* Minimal Detectable Change
  
:::
::::

## In-bed models {transition="convex"}

![](visuals/plot_hyper_10.png)

## In-bed performance of decision tree model {transition="convex"}

:::: {.columns}

::: {.column width="60%"}
![](visuals/plot_in_bed_roc.png)
:::

::: {.column width="40%"}
```{r}
source(here::here("presentation/code/tables_performance.R"))

table_in_bed_metrics
```
:::

::::

## Lots of Metrics {transition="convex" .H2}

## {transition="convex"}

```{r}
table_sleep_metrics
```

## Bland-Altman Plots {transition="convex" .smaller}

::: {.panel-tabset}

<!-- ### Sleep Period Time {.smaller} -->

<!-- ```{r} -->
<!-- #| echo: false -->
<!-- source(here::here("presentation/code/plot_ba_metric-wise.R")) -->

<!-- spt_plots[[1]] -->

<!-- spt_plots[[2]] -->

<!-- spt_plots[[3]] -->

<!-- spt_plots[[4]] -->
<!-- ``` -->

<!-- ### Total Sleep Time {.smaller} -->

<!-- ```{r} -->
<!-- tst_plots[[1]] -->

<!-- tst_plots[[2]] -->

<!-- tst_plots[[3]] -->

<!-- tst_plots[[4]] -->
<!-- ``` -->

<!-- ### Sleep Effeciency {.smaller} -->

<!-- ```{r} -->
<!-- se_plots[[1]] -->

<!-- se_plots[[2]] -->

<!-- se_plots[[3]] -->

<!-- se_plots[[4]] -->
<!-- ``` -->


<!-- ### Latency Until Persistant Sleep {.smaller} -->

<!-- ```{r} -->
<!-- lps_plots[[1]] -->

<!-- lps_plots[[2]] -->

<!-- lps_plots[[3]] -->

<!-- lps_plots[[4]] -->
<!-- ``` -->

<!-- ### Wake After Sleep Onset {.smaller} -->

<!-- ```{r} -->
<!-- waso_plots[[1]] -->

<!-- waso_plots[[2]] -->

<!-- waso_plots[[3]] -->

<!-- waso_plots[[4]] -->
<!-- ``` -->

<!-- ::: -->

<!-- ## Bland-Altman Analysis {transition="convex" .H2} -->

<!-- ```{r} -->
<!-- source(here::here("presentation/code/table_ba.R")) -->

<!-- tab_ba_crude -->
<!-- ``` -->

<!-- ## Descriptives of Sleep Quality Statistics Across Methods {transition="convex" .H2 .smaller} -->

<!-- ```{r} -->
<!-- source(here::here("code/evaluate_models/table_descriptives_of_sleep_stats.R")) -->

<!-- tab_descriptives -->
<!-- ``` -->

<!-- ## In-bed classification flow {transition="convex" .H2} -->

<!-- ```{r} -->
<!-- read_rds(here::here("/media/esbenlykke/My Passport/crude/fitted_models/axed_models/decision_tree_in_bed_AXED.rds")) %>% -->
<!--   extract_fit_engine() |> -->
<!--   visTree( -->
<!--     height = "550px", -->
<!--     nodesPopSize = TRUE, -->
<!--     minNodeSize = 10, -->
<!--     maxNodeSize = 30, -->
<!--     fallenLeaves = TRUE, -->
<!--     legend = FALSE, -->
<!--     digits = 3, -->
<!--     direction = "UD", -->
<!--     colorVar = c( -->
<!--       "#CC5500", "#8B0000", "#FFD700", -->
<!--       "#228B22", "#654321", "#8B0000", "#FFDB58" -->
<!--     ), -->
<!--     export = FALSE -->
<!--   ) |> -->
<!--   visNodes(font = list( -->
<!--     color = "#EEE8D5", -->
<!--     size = 20, -->
<!--     strokeWidth = 1 -->
<!--   )) |> -->
<!--   visEdges(font = list( -->
<!--     color = "#EEE8D5", -->
<!--     size = 20, -->
<!--     strokeWidth = 1 -->
<!--   )) |> -->
<!--   visInteraction( -->
<!--     dragNodes = FALSE, -->
<!--     dragView = FALSE, -->
<!--     zoomView = FALSE -->
<!--   ) -->
<!-- ``` -->

<!-- --- -->

<!-- ## Sleep classification flow {transition="convex" .H2} -->

<!-- ```{r} -->
<!-- read_rds(here::here("/media/esbenlykke/My Passport/crude/fitted_models/axed_models/decision_tree_sleep_AXED.rds")) %>%  -->
<!--   extract_fit_engine() |> -->
<!--   visTree( -->
<!--     height = "550px", -->
<!--     nodesPopSize = TRUE, -->
<!--     minNodeSize = 10, -->
<!--     maxNodeSize = 30, -->
<!--     fallenLeaves = TRUE, -->
<!--     legend = FALSE, -->
<!--     digits = 3, -->
<!--     direction = "UD", -->
<!--     colorVar = c( -->
<!--       "#CC5500", "#8B0000", "#FFD700", -->
<!--       "#228B22", "#654321", "#8B0000", "#FFDB58" -->
<!--     ), -->
<!--     export = FALSE -->
<!--   ) |> -->
<!--   visNodes(font = list( -->
<!--     color = "#EEE8D5", -->
<!--     strokeWidth = 1 -->
<!--   )) |> -->
<!--   visEdges(font = list( -->
<!--     color = "#EEE8D5", -->
<!--     strokeWidth = 1 -->
<!--   )) |> -->
<!--   visInteraction( -->
<!--     dragNodes = FALSE, -->
<!--     dragView = FALSE, -->
<!--     zoomView = FALSE -->
<!--   ) -->
<!-- ``` -->


<!-- # Discussion {transition="convex"} -->

<!-- ## Discussion {transition="convex" .smaller} -->

<!-- - heteroscedasticity -->
<!-- - Cheung 2018 table 4: actigraphy provides a sufficiently narrow range of possible mean differences (CI 95%) clinical significant thresholds -->
<!-- - could be interesting to build models on thigh and hip ocmbined. -->
<!-- - multiclass vs multilabel classification -->
<!-- - in-bed awake/sleep is highly imbalanced -> maybe train a new classifier accounting for imbalanced data (SMOTE) -->
<!-- - model combined preds instead? -->

<!-- ## References {transition="convex"} -->
