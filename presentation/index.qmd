---
title: "Sleep Quality Estimation using Thigh-Mounted Accelerometer Data in Free Living Conditions"
subtitle: "(working title)"
author: "Esben Lykke, PhD student"
date: "`r format(Sys.Date(), '%d %B, %Y')`"
format:
  revealjs:
    smaller: true
    theme: moon
    slide-number: true
    preview-links: auto
    logo: images/SDU_WHITE_RGB-png.png
    footer: https://github.com/esbenlykke/sleep_study
    css: my_styles.css
    scrollable: true
embed-resources: true
editor_options: 
  chunk_output_type: console
smooth-scroll: true
bibliography: references.bib
---

## Background {.scrollable transition="convex"}

```{r}
#| echo: false
library(gt)
library(arrow)
library(visNetwork)
library(tidymodels)
library(tidymodels)
```

- Sleep plays a vital role in health, thus, improving the assessment of sleepâ€“wake outside of a laboratory environment is critical
- The gold standard (PSG) is costly and inconvenient.
- Methods for estimating sleep/wake based on accelerometry exist, primarily from wrist-worn devices
- Cole-Kripke and Sadeh algorithms are commonly used
- determine in-bed time is difficult, usually set by sleep log and/or human scorers
- detect wakefulness is difficult, worse performance in populations with sleep disorders
- typically a two level analysis: epoch based and summarized across night(s)
- Zmachine-derived sleep stats
- 

Purpose...

## But Esben, what about them sleep stages!?

* I did free-living PSG recordings of sleep but...
  - Super fragile -> shitty data
  - Combersome and time consuming
  - free-living when wired up like a robot?
  - would surface skin temperature + acc be enough? Most likely needs HR
  
It was likely a dead end from the get-go :(

## Methods {transition="convex"}

- data preparation, big time-consumer is handling raw acc data
- only thigh data used. HSBC and other is only thigh data...
- all zm recording is considered as in-bed (sensor problem?)
- no sleep stages, only sleep/awake
- sensor problems during sleep, up to 20 consecutive epochs (200 sec) are treated as sleep

## Exclusion Criteria {transition="fade" .H2}

```{r}
#| fig-align: center
source(here::here("presentation/code/flowchart_eligible_nights.R"))

flow
```

::: aside
1. @hirshkowitz_national_2015
:::


## Features {transition="fade" .smaller}

:::: {.columns}

::: {.fragment .column width="30%"}

**Basic Features**

- Weekday 
- Time of Day
- Placement
- Temperature

:::

::: {.fragment .column width="30%"}

**ACC derived features**^[@skotte_detection_2014]

- Mean ACC X 
- Mean ACC Y
- Mean ACC Z
- Standard Deviation X
- Standard Deviation Y
- Standard Deviation Z
- Max Standard Deviation
- Inclination

:::

::: {.fragment .column width="40%"}

**Sensor-Independent Features**^[@walch_sleep_2019, @forger_simpler_1999]

- Clock Proxy Linear
- Clock Proxy Cosinus

:::

::::

---

## Human Circadian Clock {.smaller transition="convex"}

@forger_simpler_1999: a so-called cubic van der Pol equation

::: {.fragment}
$$\frac{dx_c}{dt}=\frac{\pi}{12}\begin{cases}\mu(x_c-\frac{4x^3}{3})-x\begin{bmatrix}(\frac{24}{0.99669\tau_x})^2+kB\end{bmatrix}\end{cases}$$
:::

::: {.fragment .fade-in-then-semi-out}
This thing is dependent on ambient light and body temperature!
:::

::: {.fragment .fade-in-then-semi-out}
@walch_sleep_2019 incorporated this feature using step counts from the Apple Watch
:::

::: {.fragment}
But as demonstrated by @walch_sleep_2019, a simple cosine function does the trick just as well :)
:::

## Circadian Proxy Features {.smaller transition="convex"}

```{r}
source(here::here("presentation/code/plot_sensor-independent.R"))

plot_proxy_cos
```

## Circadian Proxy Features {.smaller transition="convex"}

```{r}
source(here::here("presentation/code/plot_sensor-independent.R"))

plot_proxy_lin
```

## building Models {.smaller transition="convex"}

```{r}
source(here::here("presentation/code/plot_hyperparameter_tuning.R"))

hyper_plot
```

## Results {transition="fade"}

:::: {.columns}

::: {.fragment .column width="50%"}

* Performance Metrics
  - F1 Score
  - Accuracy
  - Sensitivity
  - Specificity
  - ROC curves
  
:::

::: {.fragment .column width="50%"}

* Agreement With Zmachine Sleep Stats
  - Sleep Period Time
  - Total Sleep Time
  - Sleep Efficiency
  - Latency Until Persistent Sleep
  - Wake After Sleep Onset
  
:::

::::

## ROC Curves {.smaller transition="fade"}


```{r}
source(here::here("presentation/code/plot_roc_curves.R"))

roc_plots
```


## Lots of Metrics {.smaller transition="zoom" .H2}

:::: {.columns}

::: {.column}
```{r}
source(here::here("presentation/code/tables_performance.R"))

tab1
```
:::

::: {.column}
```{r}
tab2
```
:::

::::

## Bland-Altman Plots {.smaller transition="fade"}

::: {.panel-tabset}

### Decision Tree

```{r}
#| echo: false
source(here::here("presentation/code/plot_ba.R"))
plots$decision_tree[[1]]

plots$decision_tree[[2]]

plots$decision_tree[[3]]

plots$decision_tree[[4]]

plots$decision_tree[[5]]
```

### Logistic Regression

```{r}
plots$logistic_regression[[1]]

plots$logistic_regression[[2]]

plots$logistic_regression[[3]]

plots$logistic_regression[[4]]

plots$logistic_regression[[5]]
```

### XGBoost

```{r}
plots$xgboost[[1]]

plots$xgboost[[2]]

plots$xgboost[[3]]

plots$xgboost[[4]]

plots$xgboost[[5]]
```


### Neural Net

```{r}
plots$neural_net[[1]]

plots$neural_net[[2]]

plots$neural_net[[3]]

plots$neural_net[[4]]

plots$neural_net[[5]]
```

:::

## Bland-Altman Analysis {.smaller transition="fade" .H2}

```{r}
source(here::here("presentation/code/table_ba.R"))

tab_ba
```


## In-bed classification flow {.smaller transition="zoom" .H2}

```{r}
in_bed_tree <-
  read_rds(here::here("data/models/fitted_models/in_bed_simple_CART_fit.rds"))

in_bed_tree |>
  extract_fit_engine() |>
  visTree(
    height = "550px",
    nodesPopSize = TRUE,
    minNodeSize = 10,
    maxNodeSize = 30,
    fallenLeaves = TRUE,
    legend = FALSE,
    digits = 3,
    direction = "UD",
    colorVar = c(
      "#CC5500", "#8B0000", "#FFD700",
      "#228B22", "#654321", "#8B0000", "#FFDB58"
    ),
    export = FALSE
  ) |>
  visNodes(font = list(
    color = "#EEE8D5",
    size = 20,
    strokeWidth = 1
  )) |>
  visEdges(font = list(
    color = "#EEE8D5",
    size = 20,
    strokeWidth = 1
  )) |>
  visInteraction(
    dragNodes = FALSE,
    dragView = FALSE,
    zoomView = FALSE
  )
```

---

## Sleep classification flow {.smaller transition="zoom" .H2}

```{r}
sleep_tree <-
  read_rds(here::here("data/models/fitted_models/sleep_simple_CART_fit.rds"))

sleep_tree |>
  extract_fit_engine() |>
  visTree(
    height = "550px",
    nodesPopSize = TRUE,
    minNodeSize = 10,
    maxNodeSize = 30,
    fallenLeaves = TRUE,
    legend = FALSE,
    digits = 3,
    direction = "UD",
    colorVar = c(
      "#CC5500", "#8B0000", "#FFD700",
      "#228B22", "#654321", "#8B0000", "#FFDB58"
    ),
    export = FALSE
  ) |>
  visNodes(font = list(
    color = "#EEE8D5",
    strokeWidth = 1
  )) |>
  visEdges(font = list(
    color = "#EEE8D5",
    strokeWidth = 1
  )) |>
  visInteraction(
    dragNodes = FALSE,
    dragView = FALSE,
    zoomView = FALSE
  )
```

## Discussion {.smaller transition="zoom"}

- heteroscedasticity
- Cheung 2018 table 4: actigraphy provides a sufficiently narrow range of possible mean differences (CI 95%) clinical significant thresholds
- could be interesting to build models on thigh and hip ocmbined. 

## References {transition="convex"}